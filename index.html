<!DOCTYPE html>
<html lang="vi" data-theme="dark">
<head>
    <title>Hẹn Giờ Chuông Báo (Internet)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" charset="utf-8">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        :root{--pico-border-radius:.75rem;--pico-form-element-background-color:#2b2b2b;--pico-form-element-border-color:#444}main{max-width:600px;margin:20px auto}.grid{grid-template-columns:1fr 120px;gap:0 1rem;align-items:center}.clock-container{text-align:center;margin-bottom:1rem}.clock{font-size:2.5em;font-weight:700;color:var(--pico-primary)}.date-display{font-size:.9em;margin-top:-.5rem;color:var(--pico-secondary-text-color)}.status-bar{text-align:center;margin-bottom:1rem;padding:.5rem;border-radius:var(--pico-border-radius);font-weight:500}.status-connected{background-color:#28a745;color:#fff}.status-disconnected{background-color:#dc3545;color:#fff}
    </style>
</head>
<body>
    <main class="container">
        <article>
            <header>
                <hgroup>
                    <h2>Chuông Báo Tự Động</h2>
                    <h3>Giao diện điều khiển từ xa (Internet)</h3>
                </hgroup>
            </header>
            <div class="clock-container" id="clock-wrapper" style="display: none;">
                <div id="clock" class="clock">--:--:--</div>
                <div id="date" class="date-display">Đang chờ đồng bộ...</div>
            </div>
            <div id="status" class="status-bar status-disconnected">Đang kết nối...</div>
            <details><summary><strong>LỊCH BUỔI SÁNG</strong></summary><div id="tab-container-sang"></div></details>
            <details><summary><strong>LỊCH BUỔI CHIỀU</strong></summary><div id="tab-container-chieu"></div></details>
            <details open><summary><strong>CÀI ĐẶT SỐ HỒI CHUÔNG (CHUNG)</strong></summary>
                <div class="grid"><label for="sohoi_batdau">Bắt đầu buổi học</label><input id="sohoi_batdau" type="number" value="6"></div>
                <div class="grid"><label for="sohoi_vaotiet">Vào tiết</label><input id="sohoi_vaotiet" type="number" value="5"></div>
                <div class="grid"><label for="sohoi_rachoi">Ra chơi</label><input id="sohoi_rachoi" type="number" value="3"></div>
                <div class="grid"><label for="sohoi_duvao">Dự vào lớp</label><input id="sohoi_duvao" type="number" value="2"></div>
            </details>
            <footer>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <button onclick="publishUpdate()">Lưu & Gửi Lệnh</button>
                    <button class="secondary" onclick="publishTestBell()">Thử Chuông</button>
                </div>
                <div style="text-align:center; margin-top: 1rem;"><a href="#" onclick="logout()" style="color: #ff6b6b;">Đăng xuất</a></div>
            </footer>
        </article>
    </main>
    <script>
        if("true"!==sessionStorage.getItem("isLoggedIn"))window.location.href="login.html";let client,serverTime=null;const brokerUrl="wss://366af3ec40124749863257ecd2c62b3e.s1.eu.hivemq.cloud:8884/mqtt",options={username:"ngoctuyka",password:"Tu12345678@",clientId:"WebAppClient_"+parseInt(1e3*Math.random()),reconnectPeriod:2e3};
        
        /*******************************************************
         * *** HÀM ĐƯỢC CẬP NHẬT ***
         * Thêm lệnh publish để "Hỏi" xin dữ liệu mới
         *******************************************************/
        function connectToMqtt(){
            console.log("Đang kết nối đến MQTT broker...");
            const e=document.getElementById("status");
            e.textContent="Đang kết nối...",e.className="status-bar status-disconnected";
            client=mqtt.connect(brokerUrl,options);
            client.on("connect",()=>{
                console.log("Đã kết nối thành công đến MQTT broker!");
                e.textContent="Đã kết nối",e.className="status-bar status-connected";
                document.getElementById("clock-wrapper").style.display="block";
                client.subscribe("esp8266/bell/data/status",{qos:1},e=>{
                    if(e) {
                        console.error("Lỗi khi đăng ký topic status:",e);
                    } else {
                        console.log("Đăng ký nhận topic status thành công!");
                        // SAU KHI ĐĂNG KÝ, GỬI YÊU CẦU LẤY DỮ LIỆU MỚI NHẤT
                        client.publish('esp8266/bell/data/get', '1', { qos: 1 });
                        console.log("Da gui yeu cau cap nhat trang thai.");
                    }
                });
            });
            client.on("message",(e,t)=>{const o=t.toString();"esp8266/bell/data/status"===e&&o&&_load(o)});
            client.on("error",e=>console.error("Lỗi kết nối MQTT:",e));
            client.on("close",()=>{console.log("Mất kết nối MQTT. Đang thử kết nối lại..."),e.textContent="Mất kết nối. Đang thử lại...",e.className="status-bar status-disconnected",document.getElementById("clock-wrapper").style.display="none",serverTime=null});
        }

        function _load(e){try{const t=JSON.parse(e);t.schedule&&t.epoch&&(setTime(t.epoch),populateForm(t.schedule))}catch(t){console.error("Lỗi parse JSON từ MQTT:",t)}}function publishUpdate(){if(!client||!client.connected)return void alert("Chưa kết nối đến máy chủ. Vui lòng đợi hoặc kiểm tra lại kết nối mạng.");try{const e=gatherDataFromForm(),t=JSON.stringify({schedule:e});client.publish("esp8266/bell/data/set",t,{qos:1,retain:!0}),alert("Đã gửi lệnh cập nhật thành công!")}catch(e){alert("Lỗi khi thu thập dữ liệu từ form: "+e.message),console.error(e)}}function publishTestBell(){client&&client.connected?client.publish("esp8266/bell/control","TEST_BELL",{qos:1}):alert("Chưa kết nối đến máy chủ. Vui lòng đợi hoặc kiểm tra lại kết nối mạng.")}function logout(){sessionStorage.removeItem("isLoggedIn"),window.location.href="login.html"}function setTime(e){isNaN(e)||e<1e5?(console.log("Invalid epoch received, clock not set:",e),serverTime=null):(serverTime=new Date(1e3*e),document.getElementById("date").innerHTML=serverTime.toLocaleDateString("vi-VN",{weekday:"long",year:"numeric",month:"long",day:"numeric",timeZone:"Asia/Ho_Chi_Minh"}),updateLocalClock())}function updateLocalClock(){serverTime&&(serverTime.setSeconds(serverTime.getSeconds()+1),document.getElementById("clock").innerHTML=serverTime.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:"Asia/Ho_Chi_Minh",hour12:!1}))}const createDayContent=(e,t,o,n,a)=>{let l="";return n?l=`<div class="grid"><label for="chaoco_${e}">TG Chào cờ (phút)</label><input id="chaoco_${e}" type="number" value="40"></div>`:a&&(l=`<div class="grid"><label for="chunhiem_${e}">TG Chủ nhiệm (phút)</label><input id="chunhiem_${e}" type="number" value="15"></div>`),`<h4>${t}</h4><div class="grid"><label for="enable_${e}">Kích hoạt lịch</label><input type="checkbox" id="enable_${e}" role="switch"></div><div class="grid"><label for="gio_${e}">Giờ vào học</label><input id="gio_${e}" type="time"></div>${l}<div class="grid"><label for="tiethoc_${e}">TG Tiết học (phút)</label><input id="tiethoc_${e}" type="number" value="45"></div><div class="grid"><label for="rachoi_${e}">TG Ra chơi (phút)</label><input id="rachoi_${e}" type="number" value="5"></div><div class="grid"><label for="duvaotiet_${e}">TG Dự vào (phút)</label><input id="duvaotiet_${e}" type="number" value="3"></div><div class="grid"><label for="sotiet_${e}">Số tiết học</label><input id="sotiet_${e}" type="number" value="5"></div><details role="list"><summary>Xem lịch chi tiết</summary><div class="details-container" id="details-${e}">Bấm "Cập nhật" để xem</div></details><button class="contrast" onclick="updatePreviewTable('${e}')" style="margin-top:0.5rem; width:100%;">Cập nhật bảng chi tiết</button><hr>`},containerSang=document.getElementById("tab-container-sang"),containerChieu=document.getElementById("tab-container-chieu"),days=[{id:"t2",name:"Thứ 2",chaoCo:!0,chuNhiem:!1},{id:"t3",name:"Thứ 3",chaoCo:!1,chuNhiem:!0},{id:"t4",name:"Thứ 4",chaoCo:!1,chuNhiem:!0},{id:"t5",name:"Thứ 5",chaoCo:!1,chuNhiem:!0},{id:"t6",name:"Thứ 6",chaoCo:!1,chuNhiem:!0},{id:"t7",name:"Thứ 7",chaoCo:!1,chuNhiem:!1},{id:"cn",name:"Chủ Nhật",chaoCo:!1,chuNhiem:!1}];days.forEach(e=>{containerSang.innerHTML+=createDayContent(`${e.id}_sang`,e.name,"sang",e.chaoCo,e.chuNhiem),containerChieu.innerHTML+=createDayContent(`${e.id}_chieu`,e.name,"chieu",!1,!1)});function populateForm(e){const t=e.schedule?e.schedule:e;t&&t.sohoi&&t.lich?(console.log("Bat dau cap nhat form voi du lieu:",t),t.sohoi&&["batdau","vaotiet","rachoi","duvao"].forEach(e=>{const o=document.getElementById(`sohoi_${e}`);o&&(o.value=t.sohoi[e]||"")}),["sang","chieu"].forEach(e=>{days.forEach(o=>{const n=t.lich?.[e]?.[o.id];if(n){document.getElementById(`enable_${o.id}_${e}`).checked=n.enabled,document.getElementById(`gio_${o.id}_${e}`).value=n.gio||"",document.getElementById(`tiethoc_${o.id}_${e}`).value=n.tiethoc||"",document.getElementById(`rachoi_${o.id}_${e}`).value=n.rachoi||"",document.getElementById(`duvaotiet_${o.id}_${e}`).value=n.duvaotiet||"",document.getElementById(`sotiet_${o.id}_${e}`).value=n.sotiet||"";const t=document.getElementById(`chaoco_${o.id}_${e}`);t&&(t.value=n.chaoco||0);const a=document.getElementById(`chunhiem_${o.id}_${e}`);a&&(a.value=n.chunhiem||0),updatePreviewTable(`${o.id}_${e}`)}})})):console.error("Dữ liệu lịch học nhận được không hợp lệ hoặc không đầy đủ:",e)}function gatherDataFromForm(){const e={sohoi:{},lich:{sang:{},chieu:{}}};return["batdau","vaotiet","rachoi","duvao"].forEach(t=>{e.sohoi[t]=parseInt(document.getElementById(`sohoi_${t}`).value)||0}),["sang","chieu"].forEach(t=>{days.forEach(o=>{const n=e.lich[t][o.id]={};n.enabled=document.getElementById(`enable_${o.id}_${t}`).checked,n.gio=document.getElementById(`gio_${o.id}_${t}`).value,n.tiethoc=parseInt(document.getElementById(`tiethoc_${o.id}_${t}`).value)||0,n.rachoi=parseInt(document.getElementById(`rachoi_${o.id}_${t}`).value)||0,n.duvaotiet=parseInt(document.getElementById(`duvaotiet_${o.id}_${t}`).value)||0,n.sotiet=parseInt(document.getElementById(`sotiet_${o.id}_${t}`).value)||0;const a=document.getElementById(`chaoco_${o.id}_${t}`);a&&(n.chaoco=parseInt(a.value)||0);const l=document.getElementById(`chunhiem_${o.id}_${t}`);l&&(n.chunhiem=parseInt(l.value)||0)})}),e}function timeToMinute(e){if(!e)return 0;const[t,o]=e.split(":").map(Number);return 60*t+o}function minuteToTime(e){const t=Math.floor(e/60).toString().padStart(2,"0"),o=(e%60).toString().padStart(2,"0");return`${t}:${o}`}function calculateSchedule(e){const t=e=>parseInt(document.getElementById(e)?.value)||0,o=e=>timeToMinute(document.getElementById(e).value),n=o(`gio_${e}`),a=t(`tiethoc_${e}`),l=t(`rachoi_${e}`),c=t(`duvaotiet_${e}`),s=t(`sotiet_${e}`),i=t(`chaoco_${e}`),d=t(`chunhiem_${e}`);let r=[],u=n;if(i>0)c>0&&r.push({time:u,description:"Dự vào"}),u+=c,r.push({time:u,description:"Chào cờ"}),u+=i,r.push({time:u,description:"Vào tiết 1"});else if(d>0)r.push({time:u,description:"Bắt đầu SH"}),c>0&&r.push({time:u+d,description:"Dự vào tiết 1"}),u=u+d+c,r.push({time:u,description:"Vào tiết 1"});else r.push({time:u,description:"Vào tiết 1"});for(let e=1;e<=s;e++){let t=u+a;e<s?(l>0&&r.push({time:t,description:`Ra chơi tiết ${e}`}),u=(t+=l)+c,c>0&&r.push({time:t,description:`Dự vào tiết ${e+1}`}),r.push({time:u,description:`Vào tiết ${e+1}`}))  :l>0&&r.push({time:t,description:"Ra về"})}const m=Array.from(new Map(r.map(e=>[e.time,e])).values());return m.map(e=>({...e,time:minuteToTime(e.time)})).sort((e,t)=>timeToMinute(e.time)-timeToMinute(t.time))}function updatePreviewTable(e){const t=document.getElementById(`enable_${e}`).checked,o=document.getElementById("details-"+e);if(!o)return;if(!t)return void(o.innerHTML="Bảng chi tiết bị tắt");const n=calculateSchedule(e);let a="<table><thead><tr><th>STT</th><th>Thời gian</th><th>Nội dung</th></tr></thead><tbody>";n.forEach((e,t)=>{a+=`<tr><td>${t+1}</td><td>${e.time}</td><td>${e.description}</td></tr>`}),a+="</tbody></table>",o.innerHTML=a}window.onload=function(){connectToMqtt(),setInterval(updateLocalClock,1e3)};
    </script>
</body>
</html>

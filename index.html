<!DOCTYPE html>
<html lang="vi">
<head>
  <title>Hẹn Giờ Chuông Báo - Điều khiển Internet</title>
  <meta name="viewport" content="width=device-width,user-scalable=0" charset="utf-8">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js" type="text/javascript"></script>
  
  <style type="text/css">
    /* --- CÀI ĐẶT CHUNG & SỬA LỖI TRÀN KHUNG --- */
    * {
        box-sizing: border-box;
    }
    body {
        background: #2c3e50;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #ecf0f1;
    }
    #main {
        margin: 10px auto;
        width: 360px; /* Chiều rộng cố định cho điện thoại */
    }

    /* --- KHUNG NỘI DUNG CHÍNH --- */
    #content {
        background-color: #34495e; /* Màu nền đồng nhất */
        border: 1px solid #4a627a;
        width: 100%;
        float: left;
        border-radius: 12px;
        padding-bottom: 20px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    }

    /* --- TIÊU ĐỀ & MÀU SẮC NỔI BẬT --- */
    h2 {
        font-size: 1.4em;
        margin-top: 20px;
        margin-bottom: 10px;
        text-align: center;
        color: #f1c40f;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }
    h3 {
        margin-top: 25px;
        margin-bottom: 15px; /* Giảm margin bottom */
        text-align: center;
        font-size: 1.1em;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        /* === THAY ĐỔI: Thêm khung nền cho tiêu đề === */
        padding: 8px 15px;
        background-color: #2c3e50;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        margin-left: 15px;
        margin-right: 15px;
        border-left: 4px solid; /* Thêm viền màu để nhấn mạnh */
    }
    #header-sang { 
        color: #2ecc71; 
        text-shadow: 0 0 10px rgba(46, 204, 113, 0.7);
        border-color: #2ecc71;
    }
    #header-chieu { 
        color: #3498db; 
        text-shadow: 0 0 10px rgba(52, 152, 219, 0.7);
        border-color: #3498db;
    }
    hr { border: none; height: 1px; background-color: #4a627a; margin: 25px 15px; }

    /* --- CÁC HÀNG CÀI ĐẶT CHUNG --- */
    .row {
        margin-bottom: 10px;
        float: left;
        width: 100%;
        min-height: 40px;
        display: flex;
        align-items: center;
    }
    .div1 { padding: 0 15px; float: left; margin-bottom: 10px; width: 100%; }
    .tab1 { width: 150px; float: left; line-height: 25px; font-size: 0.9em; }
    .tab2 { width: 160px; float: left; display: flex; align-items: center; justify-content: space-between; }
    
    input[type="number"], input[type="time"] {
        width: 85px;
        float: left;
        margin-right: 10px;
        background-color: #2c3e50;
        border: 1px solid #555;
        color: white;
        border-radius: 5px;
        padding: 8px;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
        border-top-color: #222;
    }
    input[type="checkbox"].enable-checkbox { width: 20px; height: 20px; flex-shrink: 0; }
    
    /* --- THANH TRẠNG THÁI & ĐỒNG HỒ --- */
    .status-bar { 
        padding: 8px 15px;
        margin: 0 15px 10px 15px; 
        text-align: center; 
        font-weight: bold; 
        border-radius: 6px; 
        transition: all 0.5s;
        font-size: 0.85em;
        text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .status-connected { background-color: #27ae60; color: white; }
    .status-disconnected { background-color: #c0392b; color: white; }
    .status-connecting { background-color: #7f8c8d; color: white; }
    .clock-container { text-align: center; margin: 20px 15px; background-color: #2c3e50; border: 1px solid #f1c40f; border-radius: 10px; padding: 15px 10px; box-shadow: inset 0 0 15px rgba(241, 196, 15, 0.3), 0 2px 5px rgba(0,0,0,0.3); }
    .clock { font-size: 2.8em; color: #f1c40f; text-shadow: 0 0 8px rgba(241, 196, 15, 0.7); font-family: 'Courier New', Courier, monospace; letter-spacing: 3px;}
    .date-display { font-size: 1em; color: #ecf0f1; margin-top: 5px; }

    /* --- NÚT BẤM 3D --- */
    .button-container { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-top: 20px; padding: 0 15px; }
    input[type="button"] {
        padding: 12px 5px;
        font-size: 0.8em;
        font-weight: bold; border-radius: 8px; border: 1px solid rgba(0,0,0,0.2); cursor: pointer; transition: all 0.1s ease-out; color: white; text-transform: uppercase; letter-spacing: 0.5px;
        border-bottom-width: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    input[type="button"]:active { transform: translateY(3px); box-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    .save-button { background-color: #2980b9; border-color: #206390; }
    .test-button { background-color: #e74c3c; border-color: #b83c2f; }
    .preview-button { background-color: #27ae60; border-color: #1f8a4c; margin-top: 10px; width: 100%; }

    /* --- TAB NGÀY & NỘI DUNG TAB --- */
    .tab { display: flex; justify-content: space-around; border-bottom: 2px solid #4a627a; margin: 0 15px 0 15px; }
    .tab button {
        flex-grow: 1;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 10px 5px;
        transition: all 0.2s ease;
        font-size: 0.8em;
        font-weight: bold;
        border-radius: 6px 6px 0 0;
        margin: 0 2px;
        position: relative;
        top: 2px;
        border-bottom: 3px solid transparent;
        background-color: #405569;
        color: #bdc3c7;
    }
    .tab button.active { 
        background-color: #4a627a;
        color: white; 
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        border-bottom-color: #f1c40f;
    }
    #tab_sang button.active { color: #2ecc71; }
    #tab_chieu button.active { color: #3498db; }
    
    .tabcontent { 
        display: none; 
        padding: 15px;
        background-color: #34495e;
    }
    .tabcontent h3 { font-size: 1.0em; margin-top: 0; margin-bottom: 15px; border: none; box-shadow: none; background: none; }
    
    /* --- KHU VỰC CÀI ĐẶT (DETAILS) --- */
    details {
        border: 1px solid #4a627a; border-radius: 8px; margin-bottom: 10px;
        background-color: #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        overflow: hidden;
    }
    summary {
        font-weight: bold; padding: 12px 15px; cursor: pointer; outline: none; color: #f1c40f;
        transition: background-color 0.2s;
    }
    details[open] > summary { background-color: #405569; }
    .details-content { padding: 10px 15px 15px 15px; border-top: 1px solid #4a627a; }
    
    /* --- CĂN CHỈNH CÁC KHU VỰC CỤ THỂ --- */
    summary#header-sohoi, 
    .tabcontent details summary {
        text-align: center;
    }
    #header-sohoi + .details-content .row { justify-content: flex-start; }
    #header-sohoi + .details-content .tab1 { width: 140px; }
    #header-sohoi + .details-content .tab2 { width: 120px; }
    
    /* --- BẢNG LỊCH CHI TIẾT --- */
    .details-container table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .details-container th, .details-container td {
        border: 1px solid #4a627a; padding: 9px 5px; text-align: center; font-size: 13px;
    }
    .details-container th { background-color: #2c3e50; color: #f1c40f; font-weight: bold; }
    .details-container tbody tr:nth-child(odd) { background-color: #34495e; }
    .details-container tbody tr:nth-child(even) { background-color: #405569; }

    /* --- NÚT SAO CHÉP ĐẾN --- */
    .copy-button {
        margin-left: auto; padding: 4px 8px; font-size: 0.8em; color: white; border: none;
        border-radius: 4px; cursor: pointer; transition: background-color 0.2s;
    }
    .copy-button.sang { background-color: #28a745; }
    .copy-button.sang:hover { background-color: #218838; }
    .copy-button.chieu { background-color: #007bff; }
    .copy-button.chieu:hover { background-color: #0069d9; }
    .activation-row .tab2 { justify-content: flex-start; }

    a#logout-link { color: #e74c3c; cursor: pointer; text-decoration: none; font-weight: bold; }
    a#logout-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div id="main">
    <div id="content">
      <div style="text-align: center; padding: 15px 0 5px 0;">
        <h2 style="margin: 0; padding: 0;">CHUÔNG BÁO TỰ ĐỘNG</h2>
        <p style="margin: 5px 0 0 0; padding: 0; font-size: 1.2em; color: #f0f0f0; font-weight: bold;">THPT YÊN KHÁNH A</p>
      </div>
      <div class="clock-container" id="clock-wrapper" style="display: none;">
        <div id="clock" class="clock">--:--:--</div>
        <div id="date" class="date-display">Đang chờ đồng bộ...</div>
      </div>
      
      <div id="status" class="status-bar status-connecting">Đang kết nối...</div>
      
      <h3 id="header-sang">LỊCH BUỔI SÁNG</h3>
      <div class="tab" id="tab_sang">
        <button class="tablinks-sang" onclick="openDay(event, 't2_sang', 'sang')">Thứ 2</button>
        <button class="tablinks-sang" onclick="openDay(event, 't3_sang', 'sang')">Thứ 3</button>
        <button class="tablinks-sang" onclick="openDay(event, 't4_sang', 'sang')">Thứ 4</button>
        <button class="tablinks-sang" onclick="openDay(event, 't5_sang', 'sang')">Thứ 5</button>
        <button class="tablinks-sang" onclick="openDay(event, 't6_sang', 'sang')">Thứ 6</button>
        <button class="tablinks-sang" onclick="openDay(event, 't7_sang', 'sang')">Thứ 7</button>
        <button class="tablinks-sang" onclick="openDay(event, 'cn_sang', 'sang')">CN</button>
      </div>
      <div id="tab-container-sang"></div>
      
      <hr>

      <h3 id="header-chieu">LỊCH BUỔI CHIỀU</h3>
      <div class="tab" id="tab_chieu">
        <button class="tablinks-chieu" onclick="openDay(event, 't2_chieu', 'chieu')">Thứ 2</button>
        <button class="tablinks-chieu" onclick="openDay(event, 't3_chieu', 'chieu')">Thứ 3</button>
        <button class="tablinks-chieu" onclick="openDay(event, 't4_chieu', 'chieu')">Thứ 4</button>
        <button class="tablinks-chieu" onclick="openDay(event, 't5_chieu', 'chieu')">Thứ 5</button>
        <button class="tablinks-chieu" onclick="openDay(event, 't6_chieu', 'chieu')">Thứ 6</button>
        <button class="tablinks-chieu" onclick="openDay(event, 't7_chieu', 'chieu')">Thứ 7</button>
        <button class="tablinks-chieu" onclick="openDay(event, 'cn_chieu', 'chieu')">CN</button>
      </div>
      <div id="tab-container-chieu"></div>
      
      <div class="div1">
          <details>
              <summary id="header-sohoi">
                  <div>CÀI ĐẶT SỐ HỒI CHUÔNG</div>
                  <span style="font-size: 0.8em; font-weight: normal; color: #ccc; margin-top: 2px;">(SÁNG - CHIỀU)</span>
              </summary>
              <div class="details-content">
                  <div class="row"><div class="tab1">Bắt đầu buổi học:</div><div class="tab2"><input id="sohoi_batdau" type="number" value="6"><span>hồi</span></div></div>
                  <div class="row"><div class="tab1">Vào tiết:</div><div class="tab2"><input id="sohoi_vaotiet" type="number" value="5"><span>hồi</span></div></div>
                  <div class="row"><div class="tab1">Ra chơi:</div><div class="tab2"><input id="sohoi_rachoi" type="number" value="3"><span>hồi</span></div></div>
                  <div class="row"><div class="tab1">Dự vào lớp:</div><div class="tab2"><input id="sohoi_duvao" type="number" value="2"><span>hồi</span></div></div>
              </div>
          </details>
      </div>

      <div class="button-container">
        <input type="button" class="save-button" onclick="publishUpdate()" value="Lưu và gửi cập nhật">
        <input type="button" class="test-button" onclick="publishTestBell()" value="Thử Chuông">
      </div>

      <div style="text-align:center; margin-top:20px; float:left; width: 100%;">
         <a id="logout-link" onclick="logout()">Đăng xuất</a>
      </div>

    </div>
  </div>

  <script>
    if("true"!==sessionStorage.getItem("isLoggedIn"))window.location.href="login.html";
    
    let client,serverTime=null;
    
    const brokerUrl="wss://366af3ec40124749863257ecd2c62b3e.s1.eu.hivemq.cloud:8884/mqtt";
    const options={username:"ngoctuyka",password:"Tu12345678@",clientId:"WebAppClient_"+parseInt(1e3*Math.random()),reconnectPeriod:2e3};
    
    const ONLINE_STATUS_TOPIC = "esp32/bell/status/online";
    const DATA_STATUS_TOPIC = "esp32/bell/data/status";
    const GET_DATA_TOPIC = "esp32/bell/data/get";
    const SET_DATA_TOPIC = "esp32/bell/data/set";
    const CONTROL_TOPIC = "esp32/bell/control";

    function connectToMqtt(){
        console.log("Đang kết nối đến MQTT broker...");
        const statusDiv = document.getElementById("status");
        statusDiv.textContent="Đang kết nối...";
        statusDiv.className="status-bar status-connecting";
        
        client=mqtt.connect(brokerUrl,options);
        
        client.on("connect",()=>{
            console.log("Đã kết nối thành công đến MQTT broker!");
            
            client.subscribe([DATA_STATUS_TOPIC, ONLINE_STATUS_TOPIC], {qos:1}, (err)=>{
                if(err) {
                    console.error("Lỗi khi đăng ký topic:", err);
                } else {
                    console.log("Đăng ký nhận các topic thành công!");
                    client.publish(GET_DATA_TOPIC, '1', { qos: 1 });
                }
            });
        });
        
        client.on("message",(topic, payload)=>{
            const payloadString = payload.toString();
            console.log(`Nhận được tin nhắn từ topic: ${topic}`);
            
            if (topic === ONLINE_STATUS_TOPIC) {
                if (payloadString === 'online') {
                    statusDiv.textContent = "Thiết bị đang hoạt động";
                    statusDiv.className = "status-bar status-connected";
                    document.getElementById('clock-wrapper').style.display = 'block';
                } else {
                    statusDiv.textContent = "Thiết bị ngoại tuyến";
                    statusDiv.className = "status-bar status-disconnected";
                    document.getElementById('clock-wrapper').style.display = 'none';
                    serverTime = null;
                }
            }
            
            if (topic === DATA_STATUS_TOPIC && payloadString) {
                _load(payloadString);
            }
        });
        
        client.on("error", e => console.error("Lỗi kết nối MQTT:", e));
        
        client.on("close",()=>{
            console.log("Mất kết nối MQTT. Đang thử kết nối lại...");
            statusDiv.textContent = "Mất kết nối máy chủ";
            statusDiv.className = "status-bar status-disconnected";
            document.getElementById('clock-wrapper').style.display = 'none';
            serverTime = null;
        });
    }

    function _load(e){try{const t=JSON.parse(e);t.schedule&&t.epoch&&(setTime(t.epoch),populateForm(t))}catch(t){console.error("Lỗi parse JSON từ MQTT:",t)}}function publishUpdate(){if(!client||!client.connected)return void alert("Chưa kết nối đến máy chủ. Vui lòng đợi hoặc kiểm tra lại kết nối mạng.");try{const e=gatherDataFromForm(),t=JSON.stringify({schedule:e});client.publish(SET_DATA_TOPIC,t,{qos:1,retain:!0}),alert("Đã gửi lệnh cập nhật thành công!")}catch(e){alert("Lỗi khi thu thập dữ liệu từ form: "+e.message),console.error(e)}}function publishTestBell(){client&&client.connected?client.publish(CONTROL_TOPIC,"TEST_BELL",{qos:1}):alert("Chưa kết nối đến máy chủ. Vui lòng đợi hoặc kiểm tra lại kết nối mạng.")}function logout(){sessionStorage.removeItem("isLoggedIn"),window.location.href="login.html"}function setTime(e){isNaN(e)||e<1e5?(console.log("Invalid epoch received, clock not set:",e),serverTime=null):(serverTime=new Date(1e3*e),document.getElementById("date").innerHTML=serverTime.toLocaleDateString("vi-VN",{weekday:"long",year:"numeric",month:"long",day:"numeric",timeZone:"Asia/Ho_Chi_Minh"}),updateLocalClock())}function updateLocalClock(){serverTime&&(serverTime.setSeconds(serverTime.getSeconds()+1),document.getElementById("clock").innerHTML=serverTime.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:"Asia/Ho_Chi_Minh",hour12:!1}))}
    
    const createDayContent = (dayId, dayName, session) => {
        const hasChaoCo = (dayId === 't2_sang');
        const hasChuNhiem = (session === 'sang' && ['t3_sang', 't4_sang', 't5_sang', 't6_sang', 't7_sang'].includes(dayId));
        
        let specialPeriod = '';
        if (hasChaoCo) {
            specialPeriod = `<div class="row"><div class="tab1">TG Chào cờ:</div><div class="tab2"><input id="chaoco_${dayId}" type="number" value="40"><span>phút</span></div></div>`;
        } else if (hasChuNhiem) {
            specialPeriod = `<div class="row"><div class="tab1">TG Chủ nhiệm:</div><div class="tab2"><input id="chunhiem_${dayId}" type="number" value="15"><span>phút</span></div></div>`;
        }

        let copyButton = '';
        const isMorningCopyable = (session === 'sang' && ['t3_sang', 't4_sang', 't5_sang', 't6_sang', 't7_sang'].includes(dayId));

        if (session === 'chieu') {
            copyButton = `<button class="copy-button chieu" onclick="copyAfternoonSchedule('${dayId}')">Sao chép đến</button>`;
        } else if (isMorningCopyable) {
            copyButton = `<button class="copy-button sang" onclick="copyMorningSchedule('${dayId}')">Sao chép đến</button>`;
        }

        return `
        <div id="${dayId}" class="tabcontent">
          <h3>Cài đặt Lịch ${dayName} (Buổi ${session === 'sang' ? 'Sáng' : 'Chiều'})</h3>
          <div class="row activation-row">
            <div class="tab1"><b>Kích hoạt lịch:</b></div>
            <div class="tab2">
                <input type="checkbox" id="enable_${dayId}" class="enable-checkbox" checked>
                ${copyButton}
            </div>
          </div>
          <div class="row"><div class="tab1">Giờ vào học:</div><div class="tab2"><input id="gio_${dayId}" type="time"></div></div>
          ${specialPeriod}
          <div class="row"><div class="tab1">TG Tiết học:</div><div class="tab2"><input id="tiethoc_${dayId}" type="number" value="45"><span>phút</span></div></div>
          <div class="row"><div class="tab1">TG Ra chơi:</div><div class="tab2"><input id="rachoi_${dayId}" type="number" value="5"><span>phút</span></div></div>
          <div class="row"><div class="tab1">TG Dự vào:</div><div class="tab2"><input id="duvaotiet_${dayId}" type="number" value="3"><span>phút</span></div></div>
          <div class="row"><div class="tab1">Số tiết học:</div><div class="tab2"><input id="sotiet_${dayId}" type="number" value="5"><span>tiết</span></div></div>
          <details>
              <summary>Xem chi tiết lịch</summary>
              <div class="details-container" id="details-${dayId}"></div>
          </details>
          <input type="button" class="preview-button" onclick="updatePreviewTable('${dayId}')" value="Cập nhật bảng chi tiết">
        </div>`;
    };

    const containerSang=document.getElementById("tab-container-sang"),containerChieu=document.getElementById("tab-container-chieu"),days=[{id:"t2",name:"Thứ 2"},{id:"t3",name:"Thứ 3"},{id:"t4",name:"Thứ 4"},{id:"t5",name:"Thứ 5"},{id:"t6",name:"Thứ 6"},{id:"t7",name:"Thứ 7"},{id:"cn",name:"Chủ Nhật"}];days.forEach(e=>{containerSang.innerHTML+=createDayContent(`${e.id}_sang`,e.name,"sang"),containerChieu.innerHTML+=createDayContent(`${e.id}_chieu`,e.name,"chieu")});
    
    function populateForm(e){const t=e.schedule?e.schedule:e;t&&t.sohoi&&t.lich?(console.log("Bat dau cap nhat form voi du lieu:",t),t.sohoi&&["batdau","vaotiet","rachoi","duvao"].forEach(e=>{const o=document.getElementById(`sohoi_${e}`);o&&(o.value=t.sohoi[e]||"")}),["sang","chieu"].forEach(e=>{days.forEach(o=>{const n=t.lich?.[e]?.[o.id];if(n){document.getElementById(`enable_${o.id}_${e}`).checked=n.enabled,document.getElementById(`gio_${o.id}_${e}`).value=n.gio||"",document.getElementById(`tiethoc_${o.id}_${e}`).value=n.tiethoc||"",document.getElementById(`rachoi_${o.id}_${e}`).value=n.rachoi||"",document.getElementById(`duvaotiet_${o.id}_${e}`).value=n.duvaotiet||"",document.getElementById(`sotiet_${o.id}_${e}`).value=n.sotiet||"";const t=document.getElementById(`chaoco_${o.id}_${e}`);t&&(t.value=n.chaoco||0);const a=document.getElementById(`chunhiem_${o.id}_${e}`);a&&(a.value=n.chunhiem||0),updatePreviewTable(`${o.id}_${e}`)}})})):console.error("Dữ liệu lịch học nhận được không hợp lệ hoặc không đầy đủ:",e)}
    
    function gatherDataFromForm(){const e={sohoi:{},lich:{sang:{},chieu:{}}};return["batdau","vaotiet","rachoi","duvao"].forEach(t=>{e.sohoi[t]=parseInt(document.getElementById(`sohoi_${t}`).value)||0}),["sang","chieu"].forEach(t=>{days.forEach(o=>{const n=e.lich[t][o.id]={};n.enabled=document.getElementById(`enable_${o.id}_${t}`).checked,n.gio=document.getElementById(`gio_${o.id}_${t}`).value,n.tiethoc=parseInt(document.getElementById(`tiethoc_${o.id}_${t}`).value)||0,n.rachoi=parseInt(document.getElementById(`rachoi_${o.id}_${t}`).value)||0,n.duvaotiet=parseInt(document.getElementById(`duvaotiet_${o.id}_${t}`).value)||0,n.sotiet=parseInt(document.getElementById(`sotiet_${o.id}_${t}`).value)||0;const a=document.getElementById(`chaoco_${o.id}_${t}`);a&&(n.chaoco=parseInt(a.value)||0);const l=document.getElementById(`chunhiem_${o.id}_${t}`);l&&(n.chunhiem=parseInt(l.value)||0)})}),e}
    
    function openDay(e,t,o){let n;const a=document.getElementsByClassName("tabcontent");for(n=0;n<a.length;n++)a[n].style.display="none";const l=document.getElementsByClassName("tablinks-sang");for(n=0;n<l.length;n++)l[n].className=l[n].className.replace(" active","");const c=document.getElementsByClassName("tablinks-chieu");for(n=0;n<c.length;n++)c[n].className=c[n].className.replace(" active","");document.getElementById(t).style.display="block",e.currentTarget.className+=" active"}function timeToMinute(e){if(!e)return 0;const[t,o]=e.split(":").map(Number);return 60*t+o}function minuteToTime(e){const t=Math.floor(e/60).toString().padStart(2,"0"),o=(e%60).toString().padStart(2,"0");return`${t}:${o}`}
    
    function calculateSchedule(e){const t=e=>parseInt(document.getElementById(e)?.value)||0,o=e=>timeToMinute(document.getElementById(e).value),n=o(`gio_${e}`),a=t(`tiethoc_${e}`),l=t(`rachoi_${e}`),c=t(`duvaotiet_${e}`),s=t(`sotiet_${e}`),i=t(`chaoco_${e}`),d=t(`chunhiem_${e}`);let r=[],u=n;if(i>0)r.push({time:u,description:"Dự vào"}),u+=c,r.push({time:u,description:"Chào cờ"}),u+=i,r.push({time:u,description:"Vào tiết 1"});else if(d>0)r.push({time:u,description:"Bắt đầu SH"}),c>0&&r.push({time:u+d,description:"Dự vào tiết 1"}),u=u+d+c,r.push({time:u,description:"Vào tiết 1"});else r.push({time:u,description:"Vào tiết 1"});for(let e=1;e<=s;e++){let t=u+a;e<s?(l>0&&r.push({time:t,description:`Ra chơi tiết ${e}`}),u=(t+=l)+c,c>0&&r.push({time:t,description:`Dự vào tiết ${e+1}`}),r.push({time:u,description:`Vào tiết ${e+1}`}))  :l>0&&r.push({time:t,description:"Ra về"})}const m=Array.from(new Map(r.map(e=>[e.time,e])).values());return m.map(e=>({...e,time:minuteToTime(e.time)})).sort((e,t)=>timeToMinute(e.time)-timeToMinute(t.time))}

    function updatePreviewTable(e){const t=document.getElementById(`enable_${e}`).checked,o=document.getElementById("details-"+e);if(!o)return;if(!t)return void(o.innerHTML="<p style='text-align:center; padding: 10px;'>Lịch này đang tắt.</p>");const n=calculateSchedule(e);let a="<table><thead><tr><th>STT</th><th>Thời gian</th><th>Nội dung</th></tr></thead><tbody>";n.forEach((e,t)=>{a+=`<tr><td>${t+1}</td><td>${e.time}</td><td>${e.description}</td></tr>`}),a+="</tbody></table>",o.innerHTML=a}
    
    function copyAfternoonSchedule(sourceDayId) {
        const sourceDayName = document.querySelector(`.tablinks-chieu[onclick*="'${sourceDayId}'"]`).innerText;
        if (!confirm(`Bạn có chắc muốn sao chép lịch của ${sourceDayName} (chiều) đến tất cả các ngày còn lại của buổi chiều không?`)) return;

        const sourceData = {
            enabled: document.getElementById(`enable_${sourceDayId}`).checked,
            gio: document.getElementById(`gio_${sourceDayId}`).value,
            tiethoc: document.getElementById(`tiethoc_${sourceDayId}`).value,
            rachoi: document.getElementById(`rachoi_${sourceDayId}`).value,
            duvaotiet: document.getElementById(`duvaotiet_${sourceDayId}`).value,
            sotiet: document.getElementById(`sotiet_${sourceDayId}`).value
        };

        const sourceBaseId = sourceDayId.replace('_chieu', '');
        days.filter(day => day.id !== sourceBaseId).forEach(day => {
            const targetDayId = `${day.id}_chieu`;
            document.getElementById(`enable_${targetDayId}`).checked = sourceData.enabled;
            document.getElementById(`gio_${targetDayId}`).value = sourceData.gio;
            document.getElementById(`tiethoc_${targetDayId}`).value = sourceData.tiethoc;
            document.getElementById(`rachoi_${targetDayId}`).value = sourceData.rachoi;
            document.getElementById(`duvaotiet_${targetDayId}`).value = sourceData.duvaotiet;
            document.getElementById(`sotiet_${targetDayId}`).value = sourceData.sotiet;
            updatePreviewTable(targetDayId);
        });
        alert('Sao chép thành công! \n\nHãy nhấn nút "Lưu và gửi cập nhật" để áp dụng các thay đổi này.');
    }
    
    function copyMorningSchedule(sourceDayId) {
        const sourceDayName = document.querySelector(`.tablinks-sang[onclick*="'${sourceDayId}'"]`).innerText;
        if (!confirm(`Bạn có chắc muốn sao chép lịch của ${sourceDayName} (sáng) đến các ngày còn lại (T3-T7) không?`)) return;

        const sourceData = {
            enabled: document.getElementById(`enable_${sourceDayId}`).checked,
            gio: document.getElementById(`gio_${sourceDayId}`).value,
            chunhiem: document.getElementById(`chunhiem_${sourceDayId}`).value,
            tiethoc: document.getElementById(`tiethoc_${sourceDayId}`).value,
            rachoi: document.getElementById(`rachoi_${sourceDayId}`).value,
            duvaotiet: document.getElementById(`duvaotiet_${sourceDayId}`).value,
            sotiet: document.getElementById(`sotiet_${sourceDayId}`).value
        };

        const sourceBaseId = sourceDayId.replace('_sang', '');
        const targetDayIds = ['t3', 't4', 't5', 't6', 't7'].filter(id => id !== sourceBaseId);
        
        targetDayIds.forEach(dayId => {
            const targetDayId = `${dayId}_sang`;
            document.getElementById(`enable_${targetDayId}`).checked = sourceData.enabled;
            document.getElementById(`gio_${targetDayId}`).value = sourceData.gio;
            document.getElementById(`chunhiem_${targetDayId}`).value = sourceData.chunhiem;
            document.getElementById(`tiethoc_${targetDayId}`).value = sourceData.tiethoc;
            document.getElementById(`rachoi_${targetDayId}`).value = sourceData.rachoi;
            document.getElementById(`duvaotiet_${targetDayId}`).value = sourceData.duvaotiet;
            document.getElementById(`sotiet_${targetDayId}`).value = sourceData.sotiet;
            updatePreviewTable(targetDayId);
        });
        alert('Sao chép thành công! \n\nHãy nhấn nút "Lưu và gửi cập nhật" để áp dụng các thay đổi này.');
    }

    window.onload = function() { 
        connectToMqtt();
        setInterval(updateLocalClock, 1000);
        // === THAY ĐỔI: Bỏ đi việc tự động click vào tab buổi chiều ===
        document.querySelector(".tablinks-sang").click();
    };
  </script>
</body>
</html>
